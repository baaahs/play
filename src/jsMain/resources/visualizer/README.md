# WebGL Visualizer

The visualizer is encapsulated in a single class, `Assembly`, which is
exported on `window`. `Assembly` implements the `THREE.Object3D` interface
and should be used just like any other `Object3D`.

## Assembly API

#### new Assembly (_panelDef_, _textureDef_, _textureSize_)
 - _panelDef_: A panel definition object. This object defines the Assembly
 superstructure. It must have a `vertices` array and a `panels` map:
    ```json
    {
      "vertices": [
        { "x": -179.801, "y": 196.403, "z": 98.3863 },
        { "x": -129.301, "y": 175.728, "z": 68.1546 },
        { "x": -86.8013, "y": 196.403, "z": 98.3863 },
        ...
      ],
      "panels": {
        "51": {
          "name": "51",
          "numPixels": 360,
          "triangles": [
            { "a": 0, "b": 2, "c": 1 },
            ...
          ]
        },
        ...
      }
    }
    ```
    The _panelDef_ for the sheep is provided as `panelDef.json`.
 - _textureDef_: A texture definition object. This object defines how the
 Assembly batches panels onto textures for more efficient rendering. It must
 have a `panels` map and a `sheets` map:
    ```json
    {
      "panels": {
        "51": {
          "sheet": 4,
          "matrix": [0.396547, -0.2649643, 0, 0.3128024, -0.2649643, -0.396547, 0, 0.3630734, 0, 0, 1, 0, 0, 0, 0, 1]
        },
        ...
      },
      "sheets": {
        ...
        "4": {
          "binSize": 195
        },
        ...
      }
    }
    ```
    A good _textureDef_ for the sheep is provided as `textureDef.json`.
    These get generated by a separate program which will be made available
    eventually. :)
 - _textureSize_: The size in pixels each texture should be. This must be
 a power of two. For best results with the provided _textureDef_, use `512`.
 - _returns_ a new Assembly instance that should be added to the scene:
    ```javascript
    scene.add(assembly);
    ```

#### assembly.getPanel ( _name_ )
A method to retrieve the named Panel instance.
 - _name_: The name of the desired panel, as a string.
 - _returns_ a panel instance (see below for the Panel API)
 
#### assembly.generateRandomPixelsForAllPanels ( _colorOverride_, _depthOverride_, _orientationOverride_ )
A helper method to generate random positions, colors, depths, and orientations
for all panels according to the number of pixels for each panel as defined
in the `panelDef` definition. 
 - _colorOverride_ (optional): A `THREE.Color` instance to use for all pixels
 Otherwise, each pixel will get a random color.
 - _depthOverride_ (optional): A positive, non-zero number to use as the
 depth (in inches) of the pixel behind the panel surface. Otherwise, each
 pixel will get a random depth between 1 and 2 inches.
 - _orientationOverride_ (optional): A normalized `THREE.Vector3` instance
 to use as the orientation for each pixel. Otherwise, each pixel will get
 a random orientation within π/6 radians of parallel to the average normal
 of the panel.
 
## Panel API

Do not construct Panel directly. Its constructor is not exposed. Assembly
is responsible for constructing Panel instances. Panels may be retrieved
by name using Assembly's `getPanel` method.
 
#### panel.setPixelPositionsInAssemblySpace ( _positions_ )
Assigns all pixel positions in the coordinate space of
the Assembly (which is a `THREE.Object3D`). Currently, **depth of the pixel
behind the normalized panel surface is ignored** when using this method.
The provided position values are projected to the normalized panel plane
and reduced to two dimensions. Use the `setPixelDepths` method to set pixel
depths behild the normalized panel plane.
 - _positions_: An Array of `THREE.Vector3`s. If this is too long for the
 number of pixels in the panel it will be truncated. If it is too short,
 it will be looped over to assign all pixels, and some pixels will be identically
 positioned as a result.
 
#### panel.setPixelPositionsInPanelSpace ( _positions_ )
Assigns all pixel positions in the coordinate space of the normalized plane
of the panel. This is a 2D coordinate space in the range of `-1 ≤ {u, v} ≤ 1`,
with `{0, 0}` at the centroid of the flattened panel. Don't use this method
unless you know what you're doing. It is used by Assembly's `generateRandomPixelsForAllPanels`
method.
 - _positions_: an Array of `THREE.Vector2`s.
 

> #### Sidebar about Panel Space
> Try not to think about it too much. It's computed by projecting the
> vertices of the panel onto a plane orthogonal to the area-weighted average
> normal of the panel. The projection uses Assembly-space's {+y} axis as
> its implied "up" direction, so the projection of Assembly-space's {+y}
> axis onto the panel plane defines the {+y} direction within Panel-space.
> This is well-defined behavior for any panel that is not perfectly horizontal
> in Assembly-space (i.e., one where the projection of Assembly-space's {+y}
> axis onto the panel is a point, rather than a line. THREE handles the
> horizontal case gracefully, but in a way that does not lend itself to
> easy explanation. At any rate, it should not ever be necessary for you 
> or for shows to be concerned specifically about Panel-space. In the future,
> as needed to support shows, Assembly will expose methods for performing
> projections as needed so that show writers do not need to concern themselves
> with understanding this space.

#### panel.setPixelDepths ( _depths_ )
Sets the depth, in scene units (the provided scene is in inches) behind
the panel of each pixel
- _depths_: an Array of positive non-zero numbers

#### panel.setPixelOrientations ( _orientations_ )
Sets the orientation of each pixel in a 3D coordinate space where the normalized
flattened plane of the panel is in the {x,y} plane and {z} points out. So 
a pixel pointing straight out from the panel would need an orientation of
{0, 0, 1}.
 - _orientations_: an Array of normalized `THREE.Vector3`s.
 
#### panel.setPixelColors ( _colors_ )
Sets the color value of each pixel.
 - _colors_: an Array of `THREE.Color`s.
 
#### panel.setPixelPositionInAssemblySpace ( _index_, _position_ )
#### panel.setPixelPositionInPanelSpace ( _index_, _position_ )
#### panel.setPixelDepth ( _index_, _depth_ )
#### panel.setPixelOrientation ( _index_, _orientation_ )
#### panel.setPixelColor ( _index_, _color_ )
These are the individual pixel equivalents of the above methods. They take
a 0-based index and a single instance of the appropriate value, and affect
only a single pixel.
